name: CI (Tests, Build, Scan)

on:
  push:

  pull_request:

jobs:
    test-auth:
        name: Test auth-service
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: auth-service
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            
            - name: Set up Python
              uses: actions/setup-python@v5
              with: 
                python-version: '3.11'

            - name: Cache pip packages
              uses: actions/cache@v4
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('**auth-service/requirements.txt') }}
                restore-keys: |
                  ${{ runner.os }}-pip-auth-

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Run unit tests
              run: python -m pytest -v

    test-file:
        name: Test file_service
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: file_service
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.11'

            - name: Cache pip packages
              uses: actions/cache@v4
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('**file_service/requirements.txt') }}
                restore-keys: |
                  ${{ runner.os }}-pip-file-

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Run unit tests
              run: python -m pytest -v


    build-docker:
        name: Build Docker Images
        runs-on: ubuntu-latest
        needs: [test-auth, test-file]

        steps: 
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build auth-service image
              run: docker build -t auth-service:ci ./auth-service

            - name: Build file_service image
              run: docker build -t file-service:ci ./file_service

    scan-docker-images:
        name: Scan Docker Images (Trivy)
        runs-on: ubuntu-latest
        needs: build-docker

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v3

            - name: Build auth-service image for scan
              run: docker build -t auth-service:ci ./auth-service

            - name: Build file-service image for scan
              run: docker build -t file-service:ci ./file_service

            - name: Scan auth-service image
              uses: aquasecurity/trivy-action@0.20.0
              with:
                image-ref: auth-service:ci
                severity: HIGH,CRITICAL
                exit-code: 1
                format: table
                trivyignores: .trivyignore

            - name: Scan file-service image
              uses: aquasecurity/trivy-action@0.20.0
              with:
                image-ref: file-service:ci
                severity: HIGH,CRITICAL
                exit-code: 1
                format: table
                trivyignores: .trivyignore

    notify-stakeholders:
      name: Notify Stakeholders (Email)
      runs-on: ubuntu-latest
      needs: [test-auth, test-file, build-docker, scan-docker-images]
      if: always() && github.event_name == 'push' && github.ref == 'refs/heads/test/email'

      steps:
        - name: Send SUCCESS email
          if: >
            needs.test-auth.result == 'success' &&
            needs.test-file.result == 'success' &&
            needs.build-docker.result == 'success' &&
            needs.scan-docker-images.result == 'success'
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.gmail.com
            server_port: 587
            secure: false
            username: ${{ secrets.SMTP_USERNAME }}
            password: ${{ secrets.SMTP_PASSWORD }}
            subject: "[CI ✅] ${{ github.repository }} @ ${{ github.ref_name }}"
            to: ${{ secrets.EMAIL_TO }}
            from: "CI Bot <${{ secrets.SMTP_USERNAME }}>"
            body: |
              CI Pipeline: SUCCESS ✅
              Repo: ${{ github.repository }}
              Branch: ${{ github.ref_name }}
              Commit: ${{ github.sha }}
              Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        - name: Send FAILURE email
          if: >
            needs.test-auth.result != 'success' ||
            needs.test-file.result != 'success' ||
            needs.build-docker.result != 'success' ||
            needs.scan-docker-images.result != 'success'
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.gmail.com
            server_port: 587
            secure: false
            username: ${{ secrets.SMTP_USERNAME }}
            password: ${{ secrets.SMTP_PASSWORD }}
            subject: "[CI ❌] ${{ github.repository }} @ ${{ github.ref_name }}"
            to: ${{ secrets.EMAIL_TO }}
            from: "CI Bot <${{ secrets.SMTP_USERNAME }}>"
            body: |
              CI Pipeline: FAILURE ❌
              Repo: ${{ github.repository }}
              Branch: ${{ github.ref_name }}
              Commit: ${{ github.sha }}
              Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

              Job results:
                - test-auth: ${{ needs.test-auth.result }}
                - test-file: ${{ needs.test-file.result }}
                - build-docker: ${{ needs.build-docker.result }}
                - scan-docker-images: ${{ needs.scan-docker-images.result }}