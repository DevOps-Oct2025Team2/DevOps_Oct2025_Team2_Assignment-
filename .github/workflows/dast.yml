# DAST - Dynamic Application Security Testing with OWASP ZAP
name: DAST - OWASP ZAP Security Scan

on:
  push:
    branches: [ main, qa/qa, dev ]
  pull_request:
    branches: [ main, qa/qa, dev ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  security-events: write   # Required to upload SARIF results
  issues: write            # Optional: to create issues for findings

jobs:
  dast-scan:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Create necessary directories
      - name: Create reports directory
        run: mkdir -p reports

      # Step 3: Start databases with Docker Compose
      - name: Start database services
        run: |
          docker compose version
          docker compose up -d
          echo "Waiting for databases to be ready..."
          sleep 15

      # Step 4: Set up Python environment for services
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 5: Install dependencies and start auth-service
      - name: Start Auth Service
        run: |
          cd auth-service
          pip install -r requirements.txt
          export DATABASE_URL="postgresql+psycopg2://auth_user:auth_pass@localhost:5433/auth_db"
          export FLASK_APP=app.py
          flask db upgrade
          nohup python app.py > auth.log 2>&1 &
          echo $! > auth.pid
          cd ..
          sleep 10

      # Step 6: Install dependencies and start file-service (via docker-compose)
      - name: Wait for File Service
        run: |
          echo "File service started via docker-compose"
          sleep 10

      # Step 7: Install dependencies and start ui-gateway
      - name: Start UI Gateway
        run: |
          cd ui-gateway
          pip install -r requirements.txt
          nohup python app.py > ui.log 2>&1 &
          echo $! > ui.pid
          cd ..
          sleep 10

      # Step 8: Verify services are running
      - name: Check service health
        run: |
          echo "Checking Auth Service (port 5000)..."
          curl -f http://localhost:5000/health || echo "Auth Service not ready"
          echo "Checking File Service (port 5002)..."
          curl -f http://localhost:5002/health || echo "File Service not ready"
          echo "Checking UI Gateway (port 3000)..."
          curl -f http://localhost:3000/health || echo "UI Gateway not ready"

      # Step 9: Run OWASP ZAP Baseline Scan on UI Gateway
      - name: ZAP Baseline Scan - UI Gateway
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: 'zap-baseline-scan'
        continue-on-error: true

      # Step 10: Run OWASP ZAP API Scan on Auth Service
      - name: ZAP API Scan - Auth Service
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'auth-service/openapi.yaml'
          format: 'openapi'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: 'zap-api-auth-scan'
        continue-on-error: true

      # Step 11: Run OWASP ZAP API Scan on File Service
      - name: ZAP API Scan - File Service
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'file_service/openapi.yaml'
          format: 'openapi'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          artifact_name: 'zap-api-file-scan'
        continue-on-error: true

      # Step 12: Upload ZAP reports as artifacts
      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-zap-reports
          path: |
            report_html.html
            report_json.json
            report_md.md
            report_xml.xml

      # Step 13: Display scan summary
      - name: ZAP Scan Summary
        if: always()
        run: |
          echo "=== DAST Scan Completed ==="
          echo "Reports have been generated and uploaded as artifacts"
          echo "Check the Actions artifacts for detailed findings"

      # Step 14: Cleanup - Stop all services
      - name: Stop all services
        if: always()
        run: |
          # Stop Python services
          if [ -f auth-service/auth.pid ]; then kill $(cat auth-service/auth.pid) 2>/dev/null || true; fi
          if [ -f ui-gateway/ui.pid ]; then kill $(cat ui-gateway/ui.pid) 2>/dev/null || true; fi
          # Stop Docker services
          docker compose down -v
